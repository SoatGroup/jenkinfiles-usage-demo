#!/usr/bin/env groovy
pipeline {

    agent { label 'master' }

    options {
        timestamps()
        disableConcurrentBuilds()
        timeout(time: 1, unit: 'MINUTES')
        buildDiscarder(logRotator(numToKeepStr: '10'))
    }

    stages {
        stage('DESCRIPTION') {
            steps {
                echo('''
                This demo is made to discover agent usage :

                Requirements :
                * Run the vagrant jenkins-slave instance :
                  * Start the server instance : `vagrant up jenkins-slave --no-provision`
                  * Provision the running instance : `vagrant provision jenkins-slave`
                * Create a new credentials : http://vcap.me:8090/credentials/store/system/domain/_/newCredentials
                  * Kind : SSH Username with private key
                  * ID : 'vagrant-id'
                  * Description : 'vagrant-id'
                  * Username : 'vagrant'
                  * Private key : https://raw.githubusercontent.com/SoatGroup/jenkinsfile-usage-demo/master/vagrant-images/data/server/demo-soat
                * Create a node : http://vcap.me:8090/computer/new
                  * Node name : 'jenkins-slave'
                  * #2 of executors : 2
                  * Remote root directory : /home/vagrant
                  * Labels : 'vagrant docker'
                  * Launch method : 'Launch agent agents via SSH'
                    * Host : '192.168.10.30'
                    * Credentials : 'vagrant-id'
                    * Host Key Verification Strategy : 'Non verifying Verification Strategy'

                Pipeline description :
                * INIT : Write a sample file - All other jobs will echo where there are running and the will print the current list of files
                * NO AGENT : Run anywhere
                * AGENT - SLAVE : Use the agent to run only on the jenkins-slave instance
                * DOCKER : Use a docker container
                * DOCKER - REUSE NODE : Use a docker container and reuse the current node
                * DOCKER - ON SLAVE : Use a docker container on the slave machine
                * DOCKER - REUSE NODE - WITH LABEL : Run a docker container - Reuse node is set to true : label is not use.

                Documentation : https://jenkins.io/doc/book/pipeline/syntax/#agent
                ''')
            }
        }
        stage('INIT') {
            steps {
                echo("INIT : Running on ${NODE_NAME}")
                writeFile([encoding: 'UTF-8', file: 'sample-file.txt', text: 'Hello World'])
            }
        }
        stage('NO AGENT') {
            steps {
                echo("NO AGENT : Running on ${NODE_NAME}")
                sh('pwd && ls')
            }
        }
        stage('AGENT - SLAVE') {
            agent {
                label 'vagrant'
            }
            steps {
                echo("AGENT - SLAVE : Running on ${NODE_NAME}")
                sh('pwd && ls')
            }
        }
        stage('DOCKER') {
            agent {
                docker {
                    image 'alpine:3.9'
                    args  "-v /tmp:/tmp"
                }
            }
            steps {
                echo("DOCKER : Running on ${NODE_NAME}")
                sh('pwd && ls')
            }
        }
        stage('DOCKER - REUSE NODE') {
            agent {
                docker {
                    image 'alpine:3.9'
                    args  "-v /tmp:/tmp"
                    reuseNode true
                }
            }
            steps {
                echo("DOCKER - REUSE NODE : Running on ${NODE_NAME}")
                sh('pwd && ls')
            }
        }
        stage('DOCKER - ON SLAVE') {
            agent {
                docker {
                    image 'alpine:3.9'
                    args  "-v /proc/sys/kernel/hostname:/tmp/slave-hostname"
                    label 'vagrant'
                }
            }
            steps {
                echo("DOCKER - ON SLAVE : Running on ${NODE_NAME}")
                sh('pwd && ls')
            }
        }
        stage('DOCKER - REUSE NODE - WITH LABEL') {
            agent {
                docker {
                    image 'alpine:3.9'
                    label 'vagrant'
                    reuseNode true
                }
            }
            steps {
                echo("DOCKER - REUSE NODE - WITH LABEL : Running on ${NODE_NAME}")
                sh('pwd && ls')
            }
        }
    }
    
    post { 
        always {
            cleanWs()
        }
    }
    
}